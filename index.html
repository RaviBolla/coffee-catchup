<html>

<head>
    <title>Coffee Catchups</title>
    <script type="text/javascript">

        var names = []
        var catchups = {}

        const shuffle = () => names.sort(() => Math.random() - 0.5)

        const filterSelected = () => shuffle().sort((a, b) => catchups[a].length - catchups[b].length)
        const pick = () => {
            const filtered = filterSelected()
            const [first] = filtered

            if (catchups[first].length === names.length - 1) {
                full.innerHTML = 'End of the cycle for catchups <button onclick="restart()">Start New Cycle</button>';
                label.innerText = ""
                pair.innerText = ""
                return;
            }

            const secondFilter = filtered.filter(name => name !== first && !catchups[first].includes(name))
            let [second] = secondFilter;
            label.innerText = "Here is the pair to catchup:";
            pair.innerText = `${first.toUpperCase()} - ${second.toUpperCase()}`
            catchups[first].push(second)
            catchups[second].push(first)
            updatePairs()
        }

    </script>
</head>

<body>
    <p id="list"></p>
    <p id="full" style="color: red;"></p>
    <p id="label"></p>
    <p id="pair"></p>
    <button onclick="pick()">Spin the wheel</button>
</body>

</html>

<script>
    function updatePairs() {
        const data = names.map(name => ([name, ...catchups[name]]), [])
        console.log("updating data", data);
        const params = {
            spreadsheetId: '1mqL_X87rRvU8VO9rw3SgmokEwVnLt6Hcx374MUye4H8',
            range: 'A:Z',
            valueInputOption: 'RAW'
        }
        var request = gapi.client.sheets.spreadsheets.values.update(params, { values: data });
        request.then(function (response) {
            console.log("Updated successfully");

        }, function (reason) {
            console.error('error: ' + reason.result.error.message);
        });
    }

    function restart() {
        const params = {
            spreadsheetId: '1mqL_X87rRvU8VO9rw3SgmokEwVnLt6Hcx374MUye4H8',
            range: 'B:Z'
        }
        var request = gapi.client.sheets.spreadsheets.values.clear(params);
        request.then(function (response) {
            console.log("Data cleared successfully");
            catchups = names.reduce((obj, name) => ({ ...obj, [name]: [] }), {})
            pick()
            full.innerText = '';
        }, function (reason) {
            console.error('error: ' + reason.result.error.message);
        });
    }

    function makeApiCall() {
        var params = {
            // The spreadsheet to request.
            spreadsheetId: '1mqL_X87rRvU8VO9rw3SgmokEwVnLt6Hcx374MUye4H8',  // TODO: Update placeholder value.
            range: 'A:Z',
        };

        var request = gapi.client.sheets.spreadsheets.values.get(params);
        request.then(function (response) {
            catchups = response.result.values.reduce((acc, catchups) => {
                const [name, ...pairs] = catchups
                acc[name] = pairs
                return acc;
            }, {})
            names = Object.keys(catchups)

            const listNames = names.map(name => `<li>${name}</li>`)
            list.innerHTML = `<h2>List of people</h2><ul>${listNames.join("")}</ul>`

        }, function (reason) {
            console.error('error: ' + reason.result.error.message);
        });
    }

    function initClient() {
        var API_KEY = 'AIzaSyDRkD9Mt7fVwBupGzYAR6U2IWzWGx98vMg';  // TODO: Update placeholder with desired API key.

        var CLIENT_ID = '391661606467-uatfosnmokslgkv2teqpo2d6uhpcrmo6.apps.googleusercontent.com';  // TODO: Update placeholder with desired client ID.

        // TODO: Authorize using one of the following scopes:
        //   'https://www.googleapis.com/auth/drive'
        //   'https://www.googleapis.com/auth/drive.file'
        //   'https://www.googleapis.com/auth/drive.readonly'
        //   'https://www.googleapis.com/auth/spreadsheets'
        //   'https://www.googleapis.com/auth/spreadsheets.readonly'
        var SCOPE = 'https://www.googleapis.com/auth/spreadsheets';

        gapi.client.init({
            'apiKey': API_KEY,
            'clientId': CLIENT_ID,
            'scope': SCOPE,
            'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
        }).then(function () {
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
            updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        });
    }

    function handleClientLoad() {
        gapi.load('client:auth2', initClient);
    }

    function updateSignInStatus(isSignedIn) {
        if (isSignedIn) {
            makeApiCall();
        } else {
            handleSignIn()
        }
    }

    function handleSignIn(event) {
        gapi.auth2.getAuthInstance().signIn();
    }

    function handleSignOutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
    }
</script>
<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
<button id="signout-button" onclick="handleSignOutClick()">Sign out</button>